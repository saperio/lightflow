!function(t,n){if("function"==typeof define&&define.amd)define(["exports"],n);else if("undefined"!=typeof exports)n(exports);else{var e={exports:{}};n(e.exports),t.lightflow=e.exports}}(this,function(t){"use strict";function n(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(t){return new h(t||{})};var e=function(){function t(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},o=function t(n,e){if(null===e||"object"!==("undefined"==typeof e?"undefined":i(e)))return e;var o=("undefined"==typeof n?"undefined":i(n))!==("undefined"==typeof e?"undefined":i(e))||n instanceof Array!=e instanceof Array;if(e instanceof Array){n=o?[]:n;for(var r=0;r<e.length;++r)n[r]=t(n[r],e[r]);return n}if("object"===("undefined"==typeof e?"undefined":i(e))){n=o?{}:n;for(var a in e)e.hasOwnProperty(a)&&(n[a]=t(n[a],e[a]));return n}return e},r=function(t,n,e){if(t.active){var i=n;if(t.idx>=0){var r=t.stepChain[t.idx];if(++r.currentCount<r.maxCount)return void(r.storage=o(r.storage,n));r.storage&&(i=o(r.storage,n),r.storage=null)}if("string"==typeof e)for(var a=0;a<t.stepChain.length;++a)if(t.stepChain[a].taskList[0].label===e){t.idx=a;break}if(++t.idx<t.stepChain.length){var s=t.stepChain[t.idx];++t.stepId,s.stepId=t.stepId,s.currentCount=0,s.taskList.forEach(function(n){n.currentCount=0,n.maxCount=1,n.processTaskFn(t,n,o(void 0,i))})}else t.stop(),t.doneChain.forEach(function(t){return t.task.call(t.context,i)}),t.looped&&t.start(i)}else if(t.stopTask){var u=t.stopTask,c=u.task,f=u.context;c.call(f,n),t.stopTask=void 0}},a=function(t,n,e){r(t,e)},s=function(t,n,e){var i=n.task,o=n.context,a=t.stepId,s=function(e,i){a===t.stepId&&++n.currentCount>=n.maxCount&&r(t,e,i)},u=function(n){a===t.stepId&&c(t,n)},f=function(t){return n.maxCount=t};i.call(o,{next:s,error:u,count:f,data:e})},u=function(t,n,e){var i=n.task;i.loop(!1).start(e)},c=function(t,n){var e=t.errorChain.filter(function(n){return n.idx===t.idx}).reduce(function(t,e){var i=e.task.call(e.context,n);return void 0!==i?i:t},void 0);void 0!==e?(t.stepChain[t.idx].currentCount=t.stepChain[t.idx].maxCount,r(t,e)):(t.stop(),t.catchChain.filter(function(n){return n.idx>=t.idx}).forEach(function(t){return t.task.call(t.context,n)}))},f=function(t,n){var e=[];return n?("string"==typeof n[0]?e.push({label:n[0],processTaskFn:a}):n.forEach(function(n){"function"==typeof n?e.push({task:n,processTaskFn:s}):n instanceof h?!function(){var i=t.stepChain.length;n.done(function(n){t.stepChain[i].stepId===t.stepId&&r(t,n)}).catch(function(n){t.stepChain[i].stepId===t.stepId&&c(t,n)}),e.push({task:n,processTaskFn:u})}():e.length&&(e[e.length-1].context=n)}),e):e},h=function(){function t(e){var i=e.nothrow;n(this,t),this.nothrow=!!i,this.stepId=0,this.idx=-1,this.active=!1,this.looped=!1,this.stepChain=[],this.doneChain=[],this.errorChain=[],this.catchChain=[]}return e(t,[{key:"then",value:function(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];var i=f(this,n),o=i.length;return o&&this.stepChain.push({taskList:i,maxCount:o}),this}},{key:"race",value:function(){for(var t=arguments.length,n=Array(t),e=0;e<t;e++)n[e]=arguments[e];var i=f(this,n),o=1;return i.length&&this.stepChain.push({taskList:i,maxCount:o}),this}},{key:"error",value:function(t,n){var e=this.stepChain.length-1;return this.errorChain.push({task:t,context:n,idx:e}),this}},{key:"catch",value:function(t,n){var e=this.stepChain.length-1;return this.catchChain.push({task:t,context:n,idx:e}),this}},{key:"done",value:function(t,n){return this.doneChain.push({task:t,context:n}),this}},{key:"loop",value:function(t){return this.looped=void 0===t||t,this}},{key:"start",value:function(t){if(!this.active)return this.active=!0,this.idx=-1,r(this,t),this}},{key:"stop",value:function(t,n){return this.active&&(this.active=!1,t&&(this.stopTask={task:t,context:n})),this}}]),t}()});
//# sourceMappingURL=dist/lightflow.min.js.map